<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Tr√°mites</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        header h1 { color: #2c3e50; font-size: 28px; }
        .header-buttons { display: flex; gap: 10px; }
        .btn-primary {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        .btn-primary:hover { background: #5568d3; }
        .filtros {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filtros label { font-weight: 600; color: #2c3e50; }
        .filtros input, .filtros select {
            padding: 10px 15px;
            border: 2px solid #e8eaff;
            border-radius: 6px;
            font-size: 14px;
        }
        .categorias { display: grid; gap: 25px; }
        .categoria { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .categoria-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
        }
        .categoria-header h2 { font-size: 20px; font-weight: 600; }
        .categoria-content { padding: 20px; }
        .tramites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .tramite-card {
            background: #f8fafb;
            border: 2px solid #e8eaff;
            border-radius: 8px;
            padding: 15px;
        }
        .tramite-card h3 { color: #2c3e50; margin-bottom: 8px; }
        .tramite-card p { color: #5a6c7d; font-size: 14px; margin-bottom: 10px; }
        .tramite-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .btn-ver, .btn-editar, .btn-eliminar {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .btn-ver { background: #667eea; color: white; }
        .btn-editar { background: #4CAF50; color: white; }
        .btn-eliminar { background: #f44336; color: white; }
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 95%;
            max-width: 900px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .close {
            color: #a0aec0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: #2c3e50; }
        .modal h2 { color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e8eaff;
            flex-wrap: wrap;
        }
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #5a6c7d;
        }
        .tab.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8eaff;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .button-group { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-save { background: #7fb069; color: white; }
        .btn-cancel { background: #e8eef5; color: #2c3e50; }
        .password-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .password-content {
            background-color: white;
            margin: 20% auto;
            padding: 40px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .password-content h3 { color: #2c3e50; margin-bottom: 20px; }
        .password-group { margin-bottom: 20px; }
        .password-group label { display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; }
        .password-group input { width: 100%; padding: 12px; border: 2px solid #e8eaff; border-radius: 6px; }
        .password-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-ok { background: #7fb069; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }
        .btn-cancel-pwd { background: #e8eef5; color: #2c3e50; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }
        
        /* ZOOM STYLES */
        .modal-zoom {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            overflow: auto;
        }
        .zoom-image {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90vh;
            margin-top: 5vh;
            cursor: zoom-out;
        }
        .close-zoom {
            position: fixed;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
        }
        .close-zoom:hover { color: #ccc; }
        
        /* PRESUPUESTO STYLES */
        .presupuesto-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .conceptos-container {
            background: #f8fafb;
            border: 2px solid #e8eaff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .concepto-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid #e8eaff;
            border-radius: 6px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 100px;
            gap: 10px;
            align-items: center;
        }
        .concepto-item input {
            padding: 8px;
            border: 2px solid #e8eaff;
            border-radius: 4px;
            font-size: 13px;
        }
        .concepto-item input:focus { outline: none; border-color: #667eea; }
        .btn-eliminar-concepto {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-agregar-concepto {
            background: #667eea;
            color: white;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .resumen-presupuesto {
            background: white;
            border: 2px solid #e8eaff;
            border-radius: 6px;
            padding: 15px;
        }
        .resumen-fila {
            display: grid;
            grid-template-columns: 2fr 1fr;
            padding: 8px 0;
            border-bottom: 1px solid #e8eaff;
        }
        .resumen-fila:last-child { border-bottom: none; }
        .resumen-label { font-weight: 600; color: #2c3e50; }
        .resumen-valor { color: #667eea; font-weight: 600; }
        .resumen-total {
            display: grid;
            grid-template-columns: 2fr 1fr;
            padding: 12px 0;
            border-top: 2px solid #667eea;
            margin-top: 10px;
            font-size: 16px;
        }
        
        /* IMAGENES */
        .imagenes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .imagen-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            border: 2px solid #e8eaff;
        }
        .imagen-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            cursor: zoom-in;
        }
        .btn-eliminar-img {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
        }
        
        /* TABLA PRESUPUESTO */
        .tabla-presupuesto {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .tabla-presupuesto th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .tabla-presupuesto td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        .tabla-presupuesto tr:hover { background: #f8fafb; }
        .total-row { background: #667eea; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã Sistema de Gesti√≥n de Tr√°mites MIAA 2026</h1>
            <div class="header-buttons">
                <button class="btn-primary" onclick="abrirAgregar()">‚ûï Agregar Tr√°mite</button>
            </div>
        </header>

        <div class="filtros">
            <label>üîç Buscar:</label>
            <input type="text" id="filtroNombre" placeholder="Nombre o Clave..." onkeyup="filtrar()">
            <label>üìÇ Categor√≠a:</label>
            <select id="filtroCategoria" onchange="filtrar()">
                <option value="">Todas</option>
            </select>
            <button class="btn-primary" onclick="limpiarFiltros()">üîÑ Limpiar</button>
            <button class="btn-primary" onclick="descargarExcel()" style="background:#27ae60;">üì• Descargar Excel</button>
        </div>

        <div class="categorias" id="categoriasContainer"></div>
    </div>

    <!-- MODAL ZOOM -->
    <div id="zoomModal" class="modal-zoom">
        <span class="close-zoom" onclick="cerrarZoom()">&times;</span>
        <img id="zoomImg" class="zoom-image">
    </div>

    <!-- MODAL VER -->
    <div id="modalVer" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalVer()">&times;</span>
            <div id="detalleContenido"></div>
            <div class="button-group">
                <button class="btn btn-cancel" onclick="cerrarModalVer()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL AGREGAR/EDITAR -->
    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalEditar()">&times;</span>
            <h2 id="tituloModal">Agregar Nuevo Tr√°mite</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab('info')">üìã Informaci√≥n</button>
                <button class="tab" onclick="cambiarTab('etapas')">üìç Etapas</button>
                <button class="tab" onclick="cambiarTab('requisitos')">‚úÖ Requisitos</button>
                <button class="tab" onclick="cambiarTab('presupuesto')">üí∞ Presupuesto</button>
                <button class="tab" onclick="cambiarTab('imagenes')">üñºÔ∏è Im√°genes</button>
            </div>

            <div id="info" class="tab-content active">
                <div class="form-group">
                    <label>Nombre del Tr√°mite *</label>
                    <input type="text" id="nombreTramite" placeholder="Nombre...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Clave *</label>
                        <input type="number" id="claveTramite">
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select id="estadoTramite">
                            <option>Agregar</option>
                            <option>Se modific√≥</option>
                            <option>Se queda igual</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Categor√≠a *</label>
                        <select id="categoriaTramite"></select>
                    </div>
                    <div class="form-group">
                        <label>Filtros</label>
                        <input type="text" id="filtrosTramite">
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n *</label>
                    <textarea id="descripcionTramite" placeholder="Descripci√≥n..."></textarea>
                </div>
                <div class="form-group">
                    <label>Resultado</label>
                    <textarea id="resultadoTramite" placeholder="Resultado..."></textarea>
                </div>
            </div>

            <div id="etapas" class="tab-content">
                <div id="etapasContainer"></div>
                <button class="btn-primary" onclick="agregarEtapa()" style="width:100%; margin-top:10px;">‚ûï Agregar Etapa</button>
            </div>

            <div id="requisitos" class="tab-content">
                <div class="form-group">
                    <label>Requisitos *</label>
                    <textarea id="requisitosTramite" placeholder="Requisitos..."></textarea>
                </div>
                <div class="form-group">
                    <label>√ìrdenes de Trabajo</label>
                    <input type="text" id="ordenesTrabajo" placeholder="OT-001, OT-002...">
                </div>
            </div>

            <div id="presupuesto" class="tab-content">
                <div class="presupuesto-header">
                    <div class="form-group">
                        <label>Nombre del Presupuesto</label>
                        <input type="text" id="nombrePresupuesto" placeholder="Ej: Presupuesto 2026">
                    </div>
                    <div class="form-group">
                        <label>Cantidad de m¬≥</label>
                        <input type="number" id="cantidadM3" placeholder="0" step="0.01" min="0" onchange="actualizarResumen()">
                    </div>
                </div>
                <h3>Conceptos</h3>
                <div class="conceptos-container" id="conceptosContainer"></div>
                <button class="btn-agregar-concepto" onclick="agregarConcepto()">‚ûï Agregar Concepto</button>
                <h3>Resumen</h3>
                <div class="resumen-presupuesto" id="resumenPresupuesto"></div>
            </div>

            <div id="imagenes" class="tab-content">
                <div class="form-group">
                    <label>Subir Im√°genes (m√°ximo 5)</label>
                    <input type="file" id="inputImagenes" multiple accept="image/*" onchange="agregarImagenes(event)">
                    <div id="imagenesContainer" class="imagenes-container" style="margin-top:15px;"></div>
                    <div id="contadorImagenes" style="margin-top:10px; color:#667eea; font-weight:600;">0/5 im√°genes</div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-save" onclick="guardarTramite()">üíæ Guardar</button>
                <button class="btn btn-cancel" onclick="cerrarModalEditar()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL CONTRASE√ëA -->
    <div id="passwordModal" class="password-modal">
        <div class="password-content">
            <h3>üîê Contrase√±a requerida</h3>
            <div class="password-group">
                <label>Contrase√±a:</label>
                <input type="password" id="passwordInput" placeholder="Ingresa contrase√±a..." onkeypress="if(event.key==='Enter') verificarPassword()">
            </div>
            <div class="password-buttons">
                <button class="btn-ok" onclick="verificarPassword()">‚úÖ Aceptar</button>
                <button class="btn-cancel-pwd" onclick="cerrarPassword()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        const PASSWORD = "admin123";
        let modoEdicion = false;
        let tramiteEnEdicion = null;
        let accionPendiente = null;
        let imagenes = [];
        let etapas = [];
        let conceptos = [];
        
        let datos = {
            categorias: [
                { id: 1, nombre: "Control de Obligaciones", tramites: [] },
                { id: 2, nombre: "Notificaciones y Cobranza", tramites: [] },
                { id: 3, nombre: "Contrataci√≥n", tramites: [] },
                { id: 4, nombre: "Contrataci√≥n en Parcialidades", tramites: [] },
                { id: 5, nombre: "Especial", tramites: [] },
                { id: 6, nombre: "General", tramites: [] },
                { id: 7, nombre: "Medidores", tramites: [] },
                { id: 8, nombre: "Grandes Usuarios", tramites: [] },
                { id: 9, nombre: "Mantenimiento", tramites: [] },
                { id: 10, nombre: "Padr√≥n y Lectura", tramites: [] }
            ]
        };

        // Cargar datos
        function cargarDatos() {
            const stored = localStorage.getItem('tramitesData');
            if (stored) datos = JSON.parse(stored);
        }

        // Guardar datos
        function guardarDatos() {
            localStorage.setItem('tramitesData', JSON.stringify(datos));
        }

        // Renderizar p√°gina
        function renderizar() {
            const container = document.getElementById('categoriasContainer');
            const filtroNombre = document.getElementById('filtroNombre').value.toLowerCase();
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            
            container.innerHTML = '';
            
            datos.categorias.forEach(cat => {
                if (filtroCategoria && cat.id != filtroCategoria) return;
                
                const tramitesFiltrados = cat.tramites.filter(t =>
                    t.nombre.toLowerCase().includes(filtroNombre) ||
                    t.descripcion.toLowerCase().includes(filtroNombre)
                );
                
                const catDiv = document.createElement('div');
                catDiv.className = 'categoria';
                catDiv.innerHTML = `<div class="categoria-header"><h2>${cat.nombre}</h2></div><div class="categoria-content"><div class="tramites-grid" id="cat${cat.id}"></div></div>`;
                
                const grid = catDiv.querySelector('.tramites-grid');
                tramitesFiltrados.forEach(t => {
                    const card = document.createElement('div');
                    card.className = 'tramite-card';
                    card.innerHTML = `
                        <h3>${t.nombre}</h3>
                        <p>${t.descripcion}</p>
                        <div style="font-size:12px; color:#667eea; margin:10px 0;">üìã ${t.etapas.length} etapas</div>
                        <div class="tramite-buttons">
                            <button class="btn-ver" onclick="verTramite(${t.clave}, ${cat.id})">üëÅÔ∏è Ver</button>
                            <button class="btn-editar" onclick="editarTramite(${t.clave}, ${cat.id})">‚úèÔ∏è Editar</button>
                            <button class="btn-eliminar" onclick="eliminarTramite(${t.clave}, ${cat.id})">üóëÔ∏è Eliminar</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
                container.appendChild(catDiv);
            });
        }

        // Ver tr√°mite
        function verTramite(clave, catId) {
            const cat = datos.categorias.find(c => c.id == catId);
            const t = cat.tramites.find(x => x.clave == clave);
            
            let html = `<h2>${t.nombre}</h2>
                <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:15px; margin:20px 0;">
                    <div style="padding:10px; background:#f8fafb; border-radius:6px;"><strong>Clave:</strong> ${t.clave}</div>
                    <div style="padding:10px; background:#f8fafb; border-radius:6px;"><strong>Estado:</strong> ${t.estado}</div>
                    <div style="padding:10px; background:#f8fafb; border-radius:6px;"><strong>Categor√≠a:</strong> ${cat.nombre}</div>
                    <div style="padding:10px; background:#f8fafb; border-radius:6px;"><strong>Filtros:</strong> ${t.filtros || 'N/A'}</div>
                </div>
                <h3 style="margin-top:20px; color:#2c3e50; border-bottom:2px solid #667eea; padding-bottom:10px;">Descripci√≥n</h3>
                <p>${t.descripcion}</p>
                <h3 style="margin-top:20px; color:#2c3e50; border-bottom:2px solid #667eea; padding-bottom:10px;">Requisitos</h3>
                <p>${t.requisitos}</p>`;
            
            if (t.resultado) {
                html += `<h3 style="margin-top:20px; color:#2c3e50; border-bottom:2px solid #667eea; padding-bottom:10px;">Resultado</h3><p>${t.resultado}</p>`;
            }
            
            if (t.etapas && t.etapas.length > 0) {
                html += '<h3 style="margin-top:20px; color:#2c3e50; border-bottom:2px solid #667eea; padding-bottom:10px;">üìç Etapas</h3>';
                t.etapas.forEach((e, i) => {
                    html += `<p><strong>Etapa ${i+1}:</strong> ${e.nombre} - ${e.descripcion}</p>`;
                });
            }
            
            // PRESUPUESTO
            if (t.presupuesto && t.presupuesto.conceptos && t.presupuesto.conceptos.length > 0) {
                html += '<h3 style="margin-top:20px; color:#2c3e50; border-bottom:2px solid #667eea; padding-bottom:10px;">üí∞ Presupuesto</h3>';
                if (t.presupuesto.nombre) html += `<p><strong>Nombre:</strong> ${t.presupuesto.nombre}</p>`;
                if (t.presupuesto.cantidadM3) html += `<p><strong>m¬≥:</strong> ${t.presupuesto.cantidadM3}</p>`;
                html += '<table class="tabla-presupuesto"><thead><tr><th>Concepto</th><th>Importe</th><th>Cantidad</th><th>Total</th></tr></thead><tbody>';
                let total = 0;
                t.presupuesto.conceptos.forEach(c => {
                    let subTotal = c.importe * c.cantidad;
                    if (c.multiplicar && t.presupuesto.cantidadM3) subTotal *= t.presupuesto.cantidadM3;
                    total += subTotal;
                    html += `<tr><td>${c.nombre}</td><td>$${c.importe.toFixed(2)}</td><td>${c.cantidad}${c.multiplicar && t.presupuesto.cantidadM3 ? ' (√óm¬≥)' : ''}</td><td>$${subTotal.toFixed(2)}</td></tr>`;
                });
                html += `<tr class="total-row"><td colspan="3">TOTAL</td><td>$${total.toFixed(2)}</td></tr></tbody></table>`;
            }
            
            // IM√ÅGENES
            if (t.imagenes && t.imagenes.length > 0) {
                html += '<h3 style="margin-top:20px; color:#2c3e50; border-bottom:2px solid #667eea; padding-bottom:10px;">üì∏ Im√°genes</h3><div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:10px;">';
                t.imagenes.forEach(img => {
                    html += `<img src="${img}" style="cursor:zoom-in; border-radius:6px; border:2px solid #e8eaff; max-width:100%; height:120px; object-fit:cover;" onclick="abrirZoom('${img}')">`;
                });
                html += '</div>';
            }
            
            document.getElementById('detalleContenido').innerHTML = html;
            document.getElementById('modalVer').style.display = 'block';
        }

        function cerrarModalVer() {
            document.getElementById('modalVer').style.display = 'none';
        }

        // Abrir agregar
        function abrirAgregar() {
            modoEdicion = false;
            limpiarFormulario();
            document.getElementById('tituloModal').textContent = '‚ûï Agregar Nuevo Tr√°mite';
            document.getElementById('modalEditar').style.display = 'block';
            actualizarSelects();
        }

        // Actualizar selects de categor√≠a
        function actualizarSelects() {
            const sel = document.getElementById('categoriaTramite');
            const filtroSel = document.getElementById('filtroCategoria');
            sel.innerHTML = '';
            filtroSel.innerHTML = '<option value="">Todas</option>';
            
            datos.categorias.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.text = c.nombre;
                sel.appendChild(opt);
                const opt2 = opt.cloneNode(true);
                filtroSel.appendChild(opt2);
            });
        }

        // Limpiar formulario
        function limpiarFormulario() {
            document.getElementById('nombreTramite').value = '';
            document.getElementById('claveTramite').value = '';
            document.getElementById('estadoTramite').value = 'Agregar';
            document.getElementById('categoriaTramite').value = '1';
            document.getElementById('filtrosTramite').value = '';
            document.getElementById('descripcionTramite').value = '';
            document.getElementById('resultadoTramite').value = '';
            document.getElementById('requisitosTramite').value = '';
            document.getElementById('ordenesTrabajo').value = '';
            document.getElementById('nombrePresupuesto').value = '';
            document.getElementById('cantidadM3').value = '';
            
            imagenes = [];
            etapas = [{ nombre: '', descripcion: '' }];
            conceptos = [];
            
            renderizarEtapas();
            renderizarConceptos();
            renderizarImagenes();
            actualizarResumen();
            
            document.getElementById('claveTramite').disabled = false;
            document.getElementById('categoriaTramite').disabled = false;
        }

        // Cambiar tab
        function cambiarTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        // Etapas
        function renderizarEtapas() {
            const container = document.getElementById('etapasContainer');
            container.innerHTML = '';
            
            etapas.forEach((e, i) => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <div style="padding:10px; background:#f8fafb; border-radius:6px; border:2px solid #e8eaff;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Etapa ${i+1}</label>
                        <input type="text" placeholder="Nombre" value="${e.nombre || ''}" onchange="etapas[${i}].nombre=this.value;" style="width:100%; padding:8px; margin-bottom:5px; border:2px solid #e8eaff; border-radius:4px;">
                        <input type="text" placeholder="Descripci√≥n" value="${e.descripcion || ''}" onchange="etapas[${i}].descripcion=this.value;" style="width:100%; padding:8px; border:2px solid #e8eaff; border-radius:4px;">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function agregarEtapa() {
            etapas.push({ nombre: '', descripcion: '' });
            renderizarEtapas();
        }

        // Conceptos presupuesto
        function renderizarConceptos() {
            const container = document.getElementById('conceptosContainer');
            container.innerHTML = '';
            
            conceptos.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'concepto-item';
                div.innerHTML = `
                    <input type="text" placeholder="Concepto" value="${c.nombre || ''}" onchange="conceptos[${i}].nombre=this.value; actualizarResumen();">
                    <input type="number" placeholder="Importe" value="${c.importe || 0}" step="0.01" min="0" onchange="conceptos[${i}].importe=parseFloat(this.value)||0; actualizarResumen();">
                    <input type="number" placeholder="Cantidad" value="${c.cantidad || 1}" step="0.01" min="0" onchange="conceptos[${i}].cantidad=parseFloat(this.value)||1; actualizarResumen();">
                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer; font-size:12px;">
                        <input type="checkbox" ${c.multiplicar ? 'checked' : ''} onchange="conceptos[${i}].multiplicar=this.checked; actualizarResumen();">
                        √ó m¬≥
                    </label>
                    <button class="btn-eliminar-concepto" onclick="conceptos.splice(${i},1); renderizarConceptos(); actualizarResumen();">‚úï</button>
                `;
                container.appendChild(div);
            });
        }

        function agregarConcepto() {
            conceptos.push({ nombre: '', importe: 0, cantidad: 1, multiplicar: false });
            renderizarConceptos();
        }

        function actualizarResumen() {
            const container = document.getElementById('resumenPresupuesto');
            const m3 = parseFloat(document.getElementById('cantidadM3').value) || 0;
            
            let totalBase = 0;
            let totalFinal = 0;
            
            conceptos.forEach(c => {
                const importe = c.importe || 0;
                totalBase += importe;
                
                let subtotal = importe * (c.cantidad || 1);
                if (c.multiplicar && m3 > 0) {
                    subtotal *= m3;
                }
                totalFinal += subtotal;
            });
            
            container.innerHTML = `
                <div class="resumen-fila">
                    <span class="resumen-label">Subtotal:</span>
                    <span class="resumen-valor">$${totalBase.toFixed(2)}</span>
                </div>
                ${m3 > 0 ? `<div class="resumen-fila"><span class="resumen-label">m¬≥:</span><span class="resumen-valor">${m3.toFixed(2)}</span></div>` : ''}
                <div class="resumen-total">
                    <span class="resumen-label">TOTAL:</span>
                    <span class="resumen-valor">$${totalFinal.toFixed(2)}</span>
                </div>
            `;
        }

        // Im√°genes
        function agregarImagenes(e) {
            const files = Array.from(e.target.files);
            const espacio = 5 - imagenes.length;
            
            files.slice(0, espacio).forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagenes.push(event.target.result);
                    renderizarImagenes();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderizarImagenes() {
            const container = document.getElementById('imagenesContainer');
            container.innerHTML = '';
            
            imagenes.forEach((img, i) => {
                const div = document.createElement('div');
                div.className = 'imagen-item';
                div.innerHTML = `
                    <img src="${img}" onclick="abrirZoom('${img}')">
                    <button class="btn-eliminar-img" onclick="imagenes.splice(${i},1); renderizarImagenes();">‚úï</button>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('contadorImagenes').textContent = `${imagenes.length}/5 im√°genes`;
        }

        // Zoom
        function abrirZoom(src) {
            document.getElementById('zoomImg').src = src;
            document.getElementById('zoomModal').style.display = 'block';
        }

        function cerrarZoom() {
            document.getElementById('zoomModal').style.display = 'none';
        }

        // Guardar
        function guardarTramite() {
            const nombre = document.getElementById('nombreTramite').value.trim();
            const clave = parseInt(document.getElementById('claveTramite').value);
            const catId = parseInt(document.getElementById('categoriaTramite').value);
            const descripcion = document.getElementById('descripcionTramite').value.trim();
            const requisitos = document.getElementById('requisitosTramite').value.trim();
            
            if (!nombre || !clave || !catId || !descripcion || !requisitos) {
                alert('Completa campos obligatorios');
                return;
            }
            
            const cat = datos.categorias.find(c => c.id == catId);
            if (!modoEdicion && cat.tramites.find(t => t.clave == clave)) {
                alert('Clave duplicada');
                return;
            }
            
            accionPendiente = 'guardar';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('passwordInput').focus();
        }

        function verificarPassword() {
            const pwd = document.getElementById('passwordInput').value;
            if (pwd !== PASSWORD) {
                alert('Contrase√±a incorrecta');
                return;
            }
            
            // ‚úÖ SI ES ELIMINAR
            if (accionPendiente === 'eliminar') {
                const cat = datos.categorias.find(c => c.id == tramiteEnEdicion.catId);
                const indice = cat.tramites.findIndex(t => t.clave == tramiteEnEdicion.clave);
                
                if (indice !== -1) {
                    const nombreTramite = cat.tramites[indice].nombre;
                    cat.tramites.splice(indice, 1);
                    alert(`‚úÖ Tr√°mite "${nombreTramite}" eliminado`);
                }
                
                guardarDatos();
                cerrarPassword();
                renderizar();
                return;
            }
            
            // ‚úÖ SI ES GUARDAR/EDITAR
            const nombre = document.getElementById('nombreTramite').value.trim();
            const clave = parseInt(document.getElementById('claveTramite').value);
            const catId = parseInt(document.getElementById('categoriaTramite').value);
            const estado = document.getElementById('estadoTramite').value;
            const filtros = document.getElementById('filtrosTramite').value.trim();
            const descripcion = document.getElementById('descripcionTramite').value.trim();
            const resultado = document.getElementById('resultadoTramite').value.trim();
            const requisitos = document.getElementById('requisitosTramite').value.trim();
            const ordenesTrabajo = document.getElementById('ordenesTrabajo').value.split(',').map(o => o.trim()).filter(o => o);
            
            const etapasLimpias = etapas.filter(e => e.nombre.trim());
            const presupuesto = {
                nombre: document.getElementById('nombrePresupuesto').value.trim(),
                cantidadM3: parseFloat(document.getElementById('cantidadM3').value) || 0,
                conceptos: conceptos
            };
            
            const tramite = {
                clave, nombre, estado, filtros, descripcion, resultado, requisitos, ordenesTrabajo,
                etapas: etapasLimpias,
                presupuesto: presupuesto,
                imagenes: imagenes
            };
            
            const cat = datos.categorias.find(c => c.id == catId);
            
            if (modoEdicion) {
                const idx = cat.tramites.findIndex(t => t.clave == tramiteEnEdicion.clave);
                cat.tramites[idx] = tramite;
                alert('‚úÖ Tr√°mite actualizado');
            } else {
                cat.tramites.push(tramite);
                alert('‚úÖ Tr√°mite agregado');
            }
            
            guardarDatos();
            cerrarModalEditar();
            cerrarPassword();
            renderizar();
        }

        function cerrarPassword() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        // Editar
        function editarTramite(clave, catId) {
            const cat = datos.categorias.find(c => c.id == catId);
            const t = cat.tramites.find(x => x.clave == clave);
            
            modoEdicion = true;
            tramiteEnEdicion = { clave, catId };
            
            document.getElementById('nombreTramite').value = t.nombre;
            document.getElementById('claveTramite').value = t.clave;
            document.getElementById('claveTramite').disabled = true;
            document.getElementById('estadoTramite').value = t.estado;
            document.getElementById('categoriaTramite').value = catId;
            document.getElementById('categoriaTramite').disabled = true;
            document.getElementById('filtrosTramite').value = t.filtros || '';
            document.getElementById('descripcionTramite').value = t.descripcion;
            document.getElementById('resultadoTramite').value = t.resultado || '';
            document.getElementById('requisitosTramite').value = t.requisitos;
            document.getElementById('ordenesTrabajo').value = (t.ordenesTrabajo || []).join(', ');
            
            etapas = t.etapas ? t.etapas.map(e => ({...e})) : [{ nombre: '', descripcion: '' }];
            imagenes = t.imagenes ? [...t.imagenes] : [];
            
            if (t.presupuesto) {
                document.getElementById('nombrePresupuesto').value = t.presupuesto.nombre || '';
                document.getElementById('cantidadM3').value = t.presupuesto.cantidadM3 || '';
                conceptos = t.presupuesto.conceptos ? t.presupuesto.conceptos.map(c => ({...c})) : [];
            } else {
                conceptos = [];
            }
            
            renderizarEtapas();
            renderizarConceptos();
            renderizarImagenes();
            actualizarResumen();
            
            document.getElementById('tituloModal').textContent = '‚úèÔ∏è Editar Tr√°mite';
            document.getElementById('modalEditar').style.display = 'block';
        }

        // Eliminar
        function eliminarTramite(clave, catId) {
            accionPendiente = 'eliminar';
            tramiteEnEdicion = { clave, catId };
            
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('passwordInput').focus();
        }

        // Cerrar modal editar
        function cerrarModalEditar() {
            document.getElementById('modalEditar').style.display = 'none';
            modoEdicion = false;
        }

        // Filtrar
        function filtrar() {
            const container = document.getElementById('categoriasContainer');
            const filtroNombre = document.getElementById('filtroNombre').value.toLowerCase();
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            
            container.innerHTML = '';
            
            datos.categorias.forEach(cat => {
                if (filtroCategoria && cat.id != filtroCategoria) return;
                
                const tramitesFiltrados = cat.tramites.filter(t =>
                    t.nombre.toLowerCase().includes(filtroNombre) ||
                    t.descripcion.toLowerCase().includes(filtroNombre) ||
                    t.clave.toString().includes(filtroNombre)
                );
                
                const catDiv = document.createElement('div');
                catDiv.className = 'categoria';
                catDiv.innerHTML = `<div class="categoria-header"><h2>${cat.nombre}</h2></div><div class="categoria-content"><div class="tramites-grid" id="cat${cat.id}"></div></div>`;
                
                const grid = catDiv.querySelector('.tramites-grid');
                tramitesFiltrados.forEach(t => {
                    const card = document.createElement('div');
                    card.className = 'tramite-card';
                    card.innerHTML = `
                        <h3>${t.nombre}</h3>
                        <p>${t.descripcion}</p>
                        <div style="font-size:12px; color:#667eea; margin:10px 0;">üìã ${t.etapas.length} etapas | üîë Clave: ${t.clave}</div>
                        <div class="tramite-buttons">
                            <button class="btn-ver" onclick="verTramite(${t.clave}, ${cat.id})">üëÅÔ∏è Ver</button>
                            <button class="btn-editar" onclick="editarTramite(${t.clave}, ${cat.id})">‚úèÔ∏è Editar</button>
                            <button class="btn-eliminar" onclick="eliminarTramite(${t.clave}, ${cat.id})">üóëÔ∏è Eliminar</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
                if (tramitesFiltrados.length > 0) {
                    container.appendChild(catDiv);
                }
            });
        }

        function limpiarFiltros() {
            document.getElementById('filtroNombre').value = '';
            document.getElementById('filtroCategoria').value = '';
            renderizar();
        }

        // ‚úÖ DESCARGAR EXCEL
        function descargarExcel() {
            if (datos.categorias.every(c => c.tramites.length === 0)) {
                alert('No hay tr√°mites para descargar');
                return;
            }

            // Crear CSV (Excel lo abre perfectamente)
            let csv = 'Clave,Nombre,Categor√≠a,Estado,Descripci√≥n,Requisitos,Etapas,Conceptos Presupuesto,Total Presupuesto,√ìrdenes de Trabajo,Im√°genes\n';
            
            datos.categorias.forEach(cat => {
                cat.tramites.forEach(t => {
                    // Etapas
                    const etapasTexto = t.etapas && t.etapas.length > 0 
                        ? t.etapas.map((e, i) => `Etapa ${i+1}: ${e.nombre} (${e.descripcion})`).join(' | ')
                        : 'Sin etapas';
                    
                    // Presupuesto
                    let presupuestoTexto = 'Sin presupuesto';
                    let totalPresupuesto = 0;
                    
                    if (t.presupuesto && t.presupuesto.conceptos && t.presupuesto.conceptos.length > 0) {
                        const conceptosTexto = t.presupuesto.conceptos.map(c => {
                            let subtotal = c.importe * c.cantidad;
                            if (c.multiplicar && t.presupuesto.cantidadM3) {
                                subtotal *= t.presupuesto.cantidadM3;
                            }
                            totalPresupuesto += subtotal;
                            return `${c.nombre}: $${c.importe} x ${c.cantidad}${c.multiplicar && t.presupuesto.cantidadM3 ? ` x ${t.presupuesto.cantidadM3}m¬≥` : ''} = $${subtotal.toFixed(2)}`;
                        }).join(' | ');
                        presupuestoTexto = t.presupuesto.nombre ? `${t.presupuesto.nombre}: ${conceptosTexto}` : conceptosTexto;
                    }
                    
                    // √ìrdenes
                    const ordenesTexto = t.ordenesTrabajo && t.ordenesTrabajo.length > 0 
                        ? t.ordenesTrabajo.join(', ')
                        : 'Sin √≥rdenes';
                    
                    // Im√°genes
                    const imagenesTexto = t.imagenes && t.imagenes.length > 0 
                        ? `${t.imagenes.length} imagen(es)`
                        : 'Sin im√°genes';
                    
                    // Crear fila CSV (escapar comillas)
                    const row = [
                        t.clave,
                        `"${t.nombre}"`,
                        `"${cat.nombre}"`,
                        t.estado,
                        `"${t.descripcion.replace(/"/g, '""')}"`,
                        `"${t.requisitos.replace(/"/g, '""')}"`,
                        `"${etapasTexto.replace(/"/g, '""')}"`,
                        `"${presupuestoTexto.replace(/"/g, '""')}"`,
                        totalPresupuesto.toFixed(2),
                        `"${ordenesTexto}"`,
                        imagenesTexto
                    ].join(',');
                    
                    csv += row + '\n';
                });
            });
            
            // Descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `tramites_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('‚úÖ Excel descargado correctamente');
        }

        // Init
        window.onload = function() {
            cargarDatos();
            actualizarSelects();
            renderizar();
        };
        
        // Actualizar resumen cuando abre presupuesto
        document.addEventListener('DOMContentLoaded', function() {
            const tabPresupuesto = document.querySelector('[onclick*="presupuesto"]');
            if (tabPresupuesto) {
                tabPresupuesto.addEventListener('click', actualizarResumen);
            }
        });
    </script>
</body>
</html>