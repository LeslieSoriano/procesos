<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Tr√°mites</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        header h1 { color: #2c3e50; font-size: 28px; }
        .header-buttons { display: flex; gap: 10px; }
        .btn-primary {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .filtros {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filtros label { font-weight: 600; color: #2c3e50; }
        .filtros input, .filtros select {
            padding: 10px 15px;
            border: 2px solid #e8eaff;
            border-radius: 6px;
            font-size: 14px;
        }
        .filtros input:focus, .filtros select:focus {
            outline: none;
            border-color: #667eea;
        }
        .categorias { display: grid; gap: 25px; }
        .categoria { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .categoria-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .categoria-header h2 { font-size: 20px; font-weight: 600; }
        .categoria-content { padding: 20px; }
        .tramites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .tramite-card {
            background: #f8fafb;
            border: 2px solid #e8eaff;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tramite-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .tramite-card h3 { color: #2c3e50; margin-bottom: 8px; }
        .tramite-card p { color: #5a6c7d; font-size: 14px; margin-bottom: 10px; }
        .tramite-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .tramite-badge {
            display: inline-block;
            background: #e8eaff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .estado-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .estado-agregar { background: #d4edda; color: #155724; }
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 12px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .close {
            color: #a0aec0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal h2 { color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .modal-section { margin-bottom: 20px; }
        .modal-section h3 { color: #2c3e50; font-size: 16px; margin-bottom: 10px; border-left: 4px solid #667eea; padding-left: 12px; }
        .modal-section p { color: #5a6c7d; line-height: 1.8; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e8eaff;
        }
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #5a6c7d;
            border-bottom: 3px solid transparent;
        }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8eaff;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .etapas-section { background: #f8fafb; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px solid #e8eaff; }
        .etapa-editor-item { background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .btn-agregar-etapa {
            background: #667eea;
            color: white;
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; flex-wrap: wrap; }
        .btn-modal { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-cerrar { background: #e8eef5; color: #2c3e50; }
        .btn-guardar { background: #7fb069; color: white; }
        .password-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .password-content {
            background-color: white;
            margin: 15% auto;
            padding: 40px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .password-content h3 { color: #2c3e50; margin-bottom: 20px; }
        .password-group { margin-bottom: 20px; }
        .password-group label { display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px; }
        .password-group input { width: 100%; padding: 12px; border: 2px solid #e8eaff; border-radius: 6px; }
        .password-group input:focus { outline: none; border-color: #667eea; }
        .password-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-password { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-confirmar { background: #7fb069; color: white; }
        .btn-cancelar-pass { background: #e8eef5; color: #2c3e50; }
        .btn-ver { background: #667eea; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .info-item { background: #f8fafb; padding: 12px; border-radius: 6px; border-left: 4px solid #667eea; }
        .info-item strong { color: #2c3e50; display: block; margin-bottom: 5px; }
        .imagenes-section { background: #f8fafb; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px solid #e8eaff; }
        .imagenes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .imagen-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            border: 2px solid #e8eaff;
        }
        .imagen-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        .imagen-item .btn-eliminar-img {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .contador-imagenes {
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            margin-top: 5px;
        }
        .input-archivo {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã Sistema de Gesti√≥n de Tr√°mites</h1>
            <div class="header-buttons">
                <button class="btn-primary" onclick="abrirNuevoTramite()">‚ûï Agregar Tr√°mite</button>
            </div>
        </header>

        <div class="filtros">
            <label for="filtroNombre">üîç Buscar:</label>
            <input type="text" id="filtroNombre" placeholder="Buscar tr√°mite...">
            <label for="filtroCategoria">üìÇ Categor√≠a:</label>
            <select id="filtroCategoria">
                <option value="">Todas</option>
            </select>
            <button class="btn-primary" onclick="resetFiltros()">üîÑ Limpiar</button>
        </div>

        <div class="categorias" id="categoriasContainer"></div>
    </div>

    <div id="modalVer" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalVer()">&times;</span>
            <div id="detalleContenido"></div>
            <div class="modal-buttons">
                <button class="btn-modal btn-cerrar" onclick="cerrarModalVer()">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="modalEdicion" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalEdicion()">&times;</span>
            <h2>Agregar Nuevo Tr√°mite</h2>
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab(this, 'info-tab')">üìã Informaci√≥n</button>
                <button class="tab" onclick="cambiarTab(this, 'etapas-tab')">üìç Etapas</button>
                <button class="tab" onclick="cambiarTab(this, 'requisitos-tab')">‚úÖ Requisitos</button>
                <button class="tab" onclick="cambiarTab(this, 'imagenes-tab')">üñºÔ∏è Im√°genes</button>
            </div>

            <div id="info-tab" class="tab-content active">
                <div class="form-group">
                    <label>Nombre del Tr√°mite *</label>
                    <input type="text" id="nombreTramite" placeholder="Nombre...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Clave *</label>
                        <input type="number" id="claveTramite" placeholder="Clave...">
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select id="estadoTramite">
                            <option>Se queda igual</option>
                            <option>Se modific√≥</option>
                            <option>Agregar</option>
                            <option>Eliminar</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Categor√≠a *</label>
                        <select id="categoriaTramite"></select>
                    </div>
                    <div class="form-group">
                        <label>Filtros</label>
                        <input type="text" id="filtrosTramite" placeholder="Filtros...">
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n *</label>
                    <textarea id="descripcionTramite" placeholder="Descripci√≥n..."></textarea>
                </div>
                <div class="form-group">
                    <label>Presupuesto</label>
                    <select id="presupuestoTramite">
                        <option value="">-- Seleccionar Presupuesto --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Resultado</label>
                    <textarea id="resultadoTramite" placeholder="Resultado..."></textarea>
                </div>
            </div>

            <div id="etapas-tab" class="tab-content">
                <div class="etapas-section" id="etapasContainer"></div>
                <button class="btn-agregar-etapa" onclick="agregarEtapa()">‚ûï Agregar Etapa</button>
            </div>

            <div id="requisitos-tab" class="tab-content">
                <div class="form-group">
                    <label>Requisitos *</label>
                    <textarea id="requisitosTramite" placeholder="Requisitos..."></textarea>
                </div>
                <div class="form-group">
                    <label>√ìrdenes de Trabajo</label>
                    <input type="text" id="ordenesTrabajo" placeholder="OT-001, OT-002...">
                </div>
            </div>

            <div id="imagenes-tab" class="tab-content">
                <div class="imagenes-section">
                    <label>Subir Im√°genes (m√°ximo 5)</label>
                    <input type="file" id="inputImagenes" multiple accept="image/*" class="input-archivo" onchange="agregarImagenes(event)">
                    <button class="btn-agregar-etapa" style="background: #667eea;" onclick="document.getElementById('inputImagenes').click()">üì∏ Seleccionar Im√°genes</button>
                    <div class="contador-imagenes" id="contadorImagenes">0/5 im√°genes</div>
                    <div class="imagenes-grid" id="imagenesGrid"></div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn-modal btn-guardar" onclick="guardarTramite()">üíæ Guardar</button>
                <button class="btn-modal btn-cerrar" onclick="cerrarModalEdicion()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="password-modal">
        <div class="password-content">
            <h3>üîê Contrase√±a requerida</h3>
            <div class="password-group">
                <label for="passwordInput">Contrase√±a:</label>
                <input type="password" id="passwordInput" placeholder="Ingresa contrase√±a...">
            </div>
            <div class="password-buttons">
                <button class="btn-password btn-confirmar" onclick="verificarContrasena()">Aceptar</button>
                <button class="btn-password btn-cancelar-pass" onclick="cerrarPasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ CORRECCI√ìN 1: Declarar las variables globales correctamente
        const CONTRASENA = "admin123";
        let imgs = [];  // ‚Üê AQU√ç ESTABA EL PROBLEMA
        let accionPendiente = null;
        let datosAccion = null;
        
        let datosGlobales = {
            categorias: [
                { id: 1, nombre: "Control de Obligaciones", tramites: [] },
                { id: 2, nombre: "Notificaciones y Cobranza", tramites: [] },
                { id: 3, nombre: "Contrataci√≥n", tramites: [] },
                { id: 4, nombre: "Contrataci√≥n en Parcialidades", tramites: [] },
                { id: 5, nombre: "Especial", tramites: [] },
                { id: 6, nombre: "General", tramites: [] },
                { id: 7, nombre: "Medidores", tramites: [] },
                { id: 8, nombre: "Grandes Usuarios", tramites: [] },
                { id: 9, nombre: "Mantenimiento", tramites: [] },
                { id: 10, nombre: "Padr√≥n y Lectura", tramites: [] }
            ]
        };

        function cargarDatos() {
            const datos = localStorage.getItem('tramitesData');
            if (datos) datosGlobales = JSON.parse(datos);
        }

        function guardarDatos() {
            localStorage.setItem('tramitesData', JSON.stringify(datosGlobales));
        }

        function renderizar() {
            const container = document.getElementById('categoriasContainer');
            const filtroNombre = document.getElementById('filtroNombre').value.toLowerCase();
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            container.innerHTML = '';

            datosGlobales.categorias.forEach(categoria => {
                if (filtroCategoria && categoria.id != filtroCategoria) return;
                const tramitesFiltrados = categoria.tramites.filter(t =>
                    t.nombre.toLowerCase().includes(filtroNombre) ||
                    t.descripcion.toLowerCase().includes(filtroNombre)
                );

                const div = document.createElement('div');
                div.className = 'categoria';
                let html = `<div class="categoria-header"><h2>${categoria.nombre}</h2></div><div class="categoria-content"><div class="tramites-grid">`;
                
                tramitesFiltrados.forEach(tramite => {
                    html += `<div class="tramite-card">
                        <h3>${tramite.nombre}</h3>
                        <p>${tramite.descripcion}</p>
                        <div class="tramite-badges">
                            <span class="tramite-badge">üìã ${tramite.etapas.length} etapas</span>
                        </div>
                        <button class="btn-ver" style="width: 100%; margin-top: 10px;" onclick="verTramite(${tramite.clave}, ${categoria.id})">üëÅÔ∏è Ver Detalles</button>
                    </div>`;
                });
                
                html += '</div></div>';
                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        function verTramite(clave, categoriaId) {
            const categoria = datosGlobales.categorias.find(c => c.id === categoriaId);
            const tramite = categoria.tramites.find(t => t.clave === clave);

            let html = `<h2>${tramite.nombre}</h2>
                <div class="info-grid">
                    <div class="info-item"><strong>Clave:</strong> <span>${tramite.clave}</span></div>
                    <div class="info-item"><strong>Categor√≠a:</strong> <span>${categoria.nombre}</span></div>
                    <div class="info-item"><strong>Estado:</strong> <span>${tramite.estado}</span></div>
                    <div class="info-item"><strong>Filtros:</strong> <span>${tramite.filtros || 'N/A'}</span></div>
                </div>

                <div class="modal-section">
                    <h3>Descripci√≥n</h3>
                    <p>${tramite.descripcion}</p>
                </div>

                <div class="modal-section">
                    <h3>Requisitos</h3>
                    <p>${tramite.requisitos}</p>
                </div>`;
            
            if (tramite.presupuesto) {
                html += `<div class="modal-section">
                    <h3>üí∞ Presupuesto</h3>
                    <p>${tramite.presupuesto}</p>
                </div>`;
            }

            if (tramite.resultado) {
                html += `<div class="modal-section">
                    <h3>üìä Resultado</h3>
                    <p>${tramite.resultado}</p>
                </div>`;
            }

            if (tramite.ordenesTrabajo && tramite.ordenesTrabajo.length > 0) {
                html += '<div class="modal-section"><h3>üìã √ìrdenes de Trabajo</h3><ul>';
                tramite.ordenesTrabajo.forEach(ot => {
                    html += `<li>${ot}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (tramite.etapas && tramite.etapas.length > 0) {
                html += '<div class="modal-section"><h3>üìç Etapas</h3>';
                tramite.etapas.forEach((e, i) => {
                    html += `<p><strong>Etapa ${i+1}:</strong> ${e.nombre} - ${e.descripcion}</p>`;
                });
                html += '</div>';
            }

            if (tramite.imagenes && tramite.imagenes.length > 0) {
                html += '<div class="modal-section"><h3>üì∏ Im√°genes</h3><div class="imagenes-detalle">';
                tramite.imagenes.forEach(img => {
                    html += `<div class="imagen-detalle"><img src="${img}" alt="Imagen tr√°mite"></div>`;
                });
                html += '</div></div>';
            }

            document.getElementById('detalleContenido').innerHTML = html;
            document.getElementById('modalVer').style.display = 'block';
        }

        function cerrarModalVer() {
            document.getElementById('modalVer').style.display = 'none';
        }

        function abrirNuevoTramite() {
            limpiarFormulario();
            document.getElementById('modalEdicion').style.display = 'block';
            renderizarEtapas([{ nombre: '', descripcion: '' }]);
            actualizarPresupuestos();
        }

        function limpiarFormulario() {
            document.getElementById('nombreTramite').value = '';
            document.getElementById('claveTramite').value = '';
            document.getElementById('estadoTramite').value = 'Se queda igual';
            document.getElementById('categoriaTramite').value = '';
            document.getElementById('filtrosTramite').value = '';
            document.getElementById('descripcionTramite').value = '';
            document.getElementById('presupuestoTramite').value = '';
            document.getElementById('requisitosTramite').value = '';
            document.getElementById('ordenesTrabajo').value = '';
            document.getElementById('resultadoTramite').value = '';
            // ‚úÖ CORRECCI√ìN 2: Limpiar el array imgs (no imagenesSubidas)
            imgs = [];
            document.getElementById('imagenesGrid').innerHTML = '';
            document.getElementById('contadorImagenes').textContent = '0/5 im√°genes';
        }

        function renderizarEtapas(etapas) {
            const html = etapas.map((e, i) => `
                <div class="etapa-editor-item">
                    <label>Etapa ${i + 1}</label>
                    <input type="text" placeholder="Nombre" value="${e.nombre}" onchange="actualizarEtapa(${i}, 'nombre', this.value)">
                    <input type="text" placeholder="Descripci√≥n" value="${e.descripcion}" onchange="actualizarEtapa(${i}, 'descripcion', this.value)">
                </div>
            `).join('');
            document.getElementById('etapasContainer').innerHTML = html;
        }

        function agregarEtapa() {
            const inputs = document.querySelectorAll('.etapa-editor-item input');
            const etapas = [];
            for (let i = 0; i < inputs.length; i += 2) {
                if (inputs[i].value) {
                    etapas.push({ nombre: inputs[i].value, descripcion: inputs[i + 1]?.value || '' });
                }
            }
            etapas.push({ nombre: '', descripcion: '' });
            renderizarEtapas(etapas);
        }

        function actualizarEtapa(idx, campo, valor) {}

        function agregarImagenes(event) {
            const archivos = Array.from(event.target.files);
            const espacioDisponible = 5 - imgs.length;
            const archivosA√±adir = archivos.slice(0, espacioDisponible);

            archivosA√±adir.forEach(archivo => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgs.push(e.target.result);
                    renderizarImagenes();
                };
                reader.readAsDataURL(archivo);
            });

            if (archivos.length > espacioDisponible) {
                alert(`‚ö†Ô∏è Solo puedes subir ${espacioDisponible} imagen(es) m√°s (m√°ximo 5)`);
            }
        }

        function renderizarImagenes() {
            const grid = document.getElementById('imagenesGrid');
            grid.innerHTML = imgs.map((img, idx) => `
                <div class="imagen-item">
                    <img src="${img}" alt="Imagen ${idx + 1}">
                    <button class="btn-eliminar-img" onclick="eliminarImagen(${idx})">‚úï</button>
                </div>
            `).join('');
            document.getElementById('contadorImagenes').textContent = `${imgs.length}/5 im√°genes`;
        }

        function eliminarImagen(idx) {
            imgs.splice(idx, 1);
            renderizarImagenes();
        }

        function actualizarPresupuestos() {
            const select = document.getElementById('presupuestoTramite');
            const presupuestos = [
                {id:1,n:'Contratacion nuevos servicios'},{id:2,n:'Venta de agua tratada'},{id:3,n:'Descarga de desechos PTAR'},{id:4,n:'Venta de agua a pipas'},{id:5,n:'Factibilidad'},{id:101,n:'Reconexi√≥n con costo'},{id:102,n:'Limpieza fosa s√©ptica en casa habitaci√≥n'},{id:103,n:'Limpieza fosa s√©ptica en comercio o industria'},{id:106,n:'Reubicaci√≥n de medidor 1/2"'},{id:109,n:'Caja de banqueta'},{id:128,n:'Reconexi√≥n de toma en caja'},{id:130,n:'Tierra Conexi√≥n de alba√±al, toma, cuadro y medidor'},{id:131,n:'Venta de medidor y/o cuadro'},{id:132,n:'Tierra Conexi√≥n de alba√±al'},{id:133,n:'Contrataci√≥n de descarga sanitaria'},{id:134,n:'Constancia de no adeudo'},{id:135,n:'Tierra Toma de agua, cuadro y/o medidor'},{id:136,n:'Reconexi√≥n por cuadro'},{id:137,n:'Reconexi√≥n por red'},{id:138,n:'Reconexi√≥n de drenaje'},{id:139,n:'Caja de banqueta y medidor'},{id:140,n:'Venta de medidor y/o cuadro nueva contrataci√≥n'},{id:141,n:'Presupuesto libre'},{id:142,n:'Columpio'},{id:143,n:'Solicitud de contratacion por alcantarillado'},{id:144,n:'Contrataci√≥n de regularizaci√≥n con medidor'},{id:145,n:'Contrataciones en parcialidades Rodamiento'},{id:146,n:'Devoluci√≥n de pago de presupuesto'},{id:147,n:'Reconexi√≥n de toma de agua'},{id:148,n:'Cancelaci√≥n de toma por fusi√≥n de predios'},{id:149,n:'Suspensi√≥n voluntaria temporal'},{id:150,n:'Reconexi√≥n de toma de agua de 1-1/2" GU'},{id:151,n:'Reconexi√≥n de toma de agua de 2" GU'},{id:152,n:'Reconexi√≥n de toma de agua de 3" GU'},{id:153,n:'Reconexi√≥n de toma de agua de 4" GU'},{id:154,n:'Copia'},{id:155,n:'Impresi√≥n estado de cuenta'},{id:156,n:'Rodamiento Cone alba√±al, toma, cuadro y/o medidor'},{id:157,n:'Rodamiento Toma de agua, cuadro y/o medidor'},{id:158,n:'Rodamiento Conexion de alba√±al'},{id:159,n:'Const, y colocaci√≥n de caja de reg en banqueta'},{id:160,n:'Venta de caja de polietileno registro en banqueta'},{id:161,n:'Contrataciones en parcialidades Tierra'},{id:162,n:'Reubicaci√≥n de medidor de 1-1/2" GU'},{id:163,n:'Reubicaci√≥n de medidor 2" GU'},{id:164,n:'Reconexi√≥n de toma de agua GU'},{id:165,n:'Venta de medidor de 1-1/2" GU'},{id:166,n:'Venta de medidor de 2" GU'},{id:167,n:'Venta de medidor de 3" GU'},{id:168,n:'Venta de medidor de 4" GU'},{id:169,n:'Reubicaci√≥n de medidor 3" GU'},{id:170,n:'Reubicaci√≥n de medidor 4" GU'},{id:171,n:'Reubicaci√≥n de cuadro 1/2 a 1"'},{id:172,n:'Reubicaci√≥n de medidor 1" GU'},{id:173,n:'Venta de medidor 1" y/o Cuadro 1/2 a 1"'},{id:174,n:'Reconexi√≥n de toma de agua 1" GU'},{id:175,n:'Rodamiento. Alba√±al, toma, cuadro y medidor G.U.'},{id:176,n:'Venta de bases de licitaci√≥n'},{id:177,n:'Rodamiento. Toma, cuadro y medidor G.U.'},{id:178,n:'Rodamiento. Alba√±al G.U.'},{id:179,n:'Tierra. Alba√±al, toma, cuadro y medidor G.U.'},{id:180,n:'Tierra. Alba√±al G.U'},{id:181,n:'Tierra. Toma, cuadro y medidor G.U.'},{id:182,n:'Rodamiento alba√±al, toma, cuadro y medidor G.U.1"'},{id:183,n:'Rodamiento alba√±al, toma, cuadro y med G.U.1 1y2"'},{id:184,n:'Rodamiento alba√±al, toma, cuadro y medidor G.U. 2"'},{id:185,n:'Rodamiento alba√±al, toma, cuadro y medidor G.U. 3"'},{id:186,n:'Rodamiento alba√±al, toma, cuadro y medidor G.U. 4"'},{id:187,n:'Rodamiento Toma, cuadro y medidor G.U. 1"'},{id:188,n:'Rodamiento Toma, cuadro y medidor G.U. 1-1/2"'},{id:189,n:'Rodamiento Toma, cuadro y medidor G.U. 2"'},{id:190,n:'Rodamiento Toma, cuadro y medidor G.U. 3"'},{id:191,n:'Rodamiento Toma, cuadro y medidor G.U. 4"'},{id:192,n:'Rodamiento conexi√≥n alba√±al G.U.'},{id:193,n:'Tierra. Alba√±al, toma, cuadro y medidor G.U. 1"'},{id:194,n:'Tierra. Alba√±al, toma, cuadro y med G.U. 1-1/2"'},{id:195,n:'Tierra. Alba√±al, toma, cuadro y medidor G.U. 2"'},{id:196,n:'Tierra. Alba√±al, toma, cuadro y medidor G.U. 3"'},{id:197,n:'Tierra. Alba√±al, toma, cuadro y medidor G.U. 4"'},{id:198,n:'Tierra. Alba√±al G.U.'},{id:199,n:'Tierra. Toma, cuadro y medidor G.U. 1"'},{id:200,n:'Tierra. Toma, cuadro y medidor G.U. 1-1/2"'},{id:201,n:'Tierra. Toma, cuadro y medidor G.U. 2"'},{id:202,n:'Tierra. Toma, cuadro y medidor G.U.3"'},{id:203,n:'Tierra. Toma, cuadro y medidor G.U. 4"'},{id:204,n:'Reconexi√≥n de toma en cuadro y/o registro'},{id:205,n:'Reconexi√≥n voluntaria temporal'},{id:206,n:'Reubicaci√≥n de medidor a caja de registro'}
            ];
            let options = '<option value="">-- Seleccionar Presupuesto --</option>';
            presupuestos.forEach(p => { options += `<option value="${p.id}">${p.id} - ${p.n}</option>`; });
            select.innerHTML = options;
        }

        function cerrarModalEdicion() {
            document.getElementById('modalEdicion').style.display = 'none';
        }

        function cambiarTab(btn, tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function guardarTramite() {
            const nombre = document.getElementById('nombreTramite').value.trim();
            const clave = parseInt(document.getElementById('claveTramite').value);
            const estado = document.getElementById('estadoTramite').value;
            const categoriaId = parseInt(document.getElementById('categoriaTramite').value);
            const filtros = document.getElementById('filtrosTramite').value.trim();
            const descripcion = document.getElementById('descripcionTramite').value.trim();
            const requisitos = document.getElementById('requisitosTramite').value.trim();
            const presupuestoId = document.getElementById('presupuestoTramite').value;
            const presupuesto = presupuestoId ? `${presupuestoId}` : 'No seleccionado';
            const resultado = document.getElementById('resultadoTramite').value.trim();
            const ordenesTrabajo = document.getElementById('ordenesTrabajo').value.split(',').map(o => o.trim()).filter(o => o);

            const inputs = document.querySelectorAll('.etapa-editor-item input');
            const etapas = [];
            for (let i = 0; i < inputs.length; i += 2) {
                if (inputs[i].value.trim()) {
                    etapas.push({ nombre: inputs[i].value.trim(), descripcion: inputs[i + 1]?.value.trim() || '' });
                }
            }

            if (!nombre || !clave || !categoriaId || !descripcion || !requisitos) {
                alert('‚ö†Ô∏è Completa campos obligatorios');
                return;
            }

            const categoria = datosGlobales.categorias.find(c => c.id === categoriaId);
            if (categoria.tramites.some(t => t.clave === clave)) {
                alert('‚ö†Ô∏è Clave duplicada');
                return;
            }

            accionPendiente = 'guardar';
            datosAccion = { 
                nombre, clave, estado, categoriaId, filtros, descripcion, requisitos, etapas, 
                presupuesto, resultado, ordenesTrabajo 
            };
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('passwordInput').focus();
        }

        function verificarContrasena() {
            if (document.getElementById('passwordInput').value === "admin123") {
                const { nombre, clave, estado, categoriaId, filtros, descripcion, requisitos, etapas, presupuesto, resultado, ordenesTrabajo } = datosAccion;
                const categoria = datosGlobales.categorias.find(c => c.id === categoriaId);
                categoria.tramites.push({ 
                    clave, nombre, estado, filtros, descripcion, requisitos, etapas, 
                    presupuesto, resultado, ordenesTrabajo, imagenes: imgs 
                });
                guardarDatos();
                cerrarModalEdicion();
                renderizar();
                alert('‚úÖ Tr√°mite agregado');
                document.getElementById('passwordModal').style.display = 'none';
            } else {
                alert('‚ùå Contrase√±a incorrecta');
            }
        }

        function cerrarPasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function resetFiltros() {
            document.getElementById('filtroNombre').value = '';
            document.getElementById('filtroCategoria').value = '';
            renderizar();
        }

        function guardarJSON() {
            const blob = new Blob([JSON.stringify(datosGlobales, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tramites_${Date.now()}.json`;
            a.click();
        }

        // ‚úÖ CORRECCI√ìN 3: Inicializar todo correctamente
        cargarDatos();
        const cats = datosGlobales.categorias.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
        document.getElementById('filtroCategoria').innerHTML = '<option value="">Todas</option>' + cats;
        document.getElementById('categoriaTramite').innerHTML = cats;
        document.getElementById('filtroNombre').addEventListener('input', renderizar);
        document.getElementById('filtroCategoria').addEventListener('change', renderizar);
        document.getElementById('passwordInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') verificarContrasena(); });
        renderizar();
    </script>
</body>
</html>